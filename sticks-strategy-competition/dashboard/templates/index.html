<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Skitgubbe Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="theme-bg">
  <nav class="navbar navbar-expand-lg navbar-dark gradient-header shadow-sm mb-4">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold d-flex align-items-center">
        <span class="logo-icon me-2">üÉè</span> Sticks Gauntlet
      </span>
      <div class="d-flex align-items-center gap-2">
        <button id="refreshBtn" class="btn btn-sm btn-light fw-semibold">Refresh</button>
        <span id="lastUpdated" class="badge text-bg-dark-subtle small">‚Äî</span>
      </div>
    </div>
  </nav>

  <main class="container-fluid px-3 px-md-4 pb-5">
    <div id="aggregate" class="row g-3 mb-4"></div>

    <!-- Navigation tabs for different leaderboards -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header py-0">
        <ul class="nav nav-tabs card-header-tabs" id="leaderboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall-pane" type="button" role="tab" aria-controls="overall-pane" aria-selected="true">
              <span class="tab-icon">üèÜ</span> Overall
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="p3-tab" data-bs-toggle="tab" data-bs-target="#p3-pane" type="button" role="tab" aria-controls="p3-pane" aria-selected="false">
              <span class="tab-icon">üë•</span> 3-Player
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="p4-tab" data-bs-toggle="tab" data-bs-target="#p4-pane" type="button" role="tab" aria-controls="p4-pane" aria-selected="false">
              <span class="tab-icon">üë•</span> 4-Player
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="p5-tab" data-bs-toggle="tab" data-bs-target="#p5-pane" type="button" role="tab" aria-controls="p5-pane" aria-selected="false">
              <span class="tab-icon">üë•</span> 5-Player
            </button>
          </li>
        </ul>
        <div class="ms-auto d-flex flex-column align-items-end gap-1 position-absolute" style="top: 0.5rem; right: 1rem;">
          <div class="small text-muted" id="gamesSummary"></div>
          <div class="small"><span id="dataSource" class="badge bg-secondary">‚Äî</span></div>
        </div>
      </div>
      
      <div class="tab-content" id="leaderboardTabContent">
        <!-- Overall Leaderboard -->
        <div class="tab-pane fade show active" id="overall-pane" role="tabpanel" aria-labelledby="overall-tab">
          <div class="table-responsive rounded-bottom">
            <table class="table table-hover align-middle mb-0" id="leaderboardTable">
              <thead>
                <tr>
                  <th scope="col" class="sortable" data-key="rank">#</th>
                  <th scope="col" class="sortable" data-key="strategy">Strategy</th>
                  <th scope="col" class="sortable" data-key="games">Games</th>
                  <th scope="col" class="sortable" data-key="losses">Losses</th>
                  <th scope="col" class="sortable" data-key="loss_rate">Loss Rate</th>
                  <th scope="col" class="sortable" data-key="avg_finish_position">Avg Finish</th>
                  <th scope="col" class="sortable" data-key="avg_wars">Wars</th>
                  <th scope="col" class="sortable" data-key="avg_kills">Kills</th>
                  <th scope="col" class="sortable" data-key="avg_eats">Eats</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <!-- 3-Player Leaderboard -->
        <div class="tab-pane fade" id="p3-pane" role="tabpanel" aria-labelledby="p3-tab">
          <div class="table-responsive rounded-bottom">
            <table class="table table-hover align-middle mb-0" id="p3Table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Strategy</th>
                  <th scope="col">Games</th>
                  <th scope="col">Losses</th>
                  <th scope="col">Loss Rate</th>
                  <th scope="col">Avg Finish</th>
                  <th scope="col">Wars</th>
                  <th scope="col">Kills</th>
                  <th scope="col">Eats</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <!-- 4-Player Leaderboard -->
        <div class="tab-pane fade" id="p4-pane" role="tabpanel" aria-labelledby="p4-tab">
          <div class="table-responsive rounded-bottom">
            <table class="table table-hover align-middle mb-0" id="p4Table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Strategy</th>
                  <th scope="col">Games</th>
                  <th scope="col">Losses</th>
                  <th scope="col">Loss Rate</th>
                  <th scope="col">Avg Finish</th>
                  <th scope="col">Wars</th>
                  <th scope="col">Kills</th>
                  <th scope="col">Eats</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <!-- 5-Player Leaderboard -->
        <div class="tab-pane fade" id="p5-pane" role="tabpanel" aria-labelledby="p5-tab">
          <div class="table-responsive rounded-bottom">
            <table class="table table-hover align-middle mb-0" id="p5Table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Strategy</th>
                  <th scope="col">Games</th>
                  <th scope="col">Losses</th>
                  <th scope="col">Loss Rate</th>
                  <th scope="col">Avg Finish</th>
                  <th scope="col">Wars</th>
                  <th scope="col">Kills</th>
                  <th scope="col">Eats</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <section class="row g-3" id="callouts"></section>

    <div class="card border-0 shadow-sm mt-4" id="recentGamesCard" style="display:none;">
      <div class="card-header py-2 d-flex align-items-center">
        <h2 class="h6 mb-0 fw-semibold">Recent Games</h2>
        <span class="ms-2 small text-muted" id="recentGamesCount"></span>
      </div>
      <div class="table-responsive" style="max-height:320px;">
        <table class="table table-sm mb-0 table-hover" id="recentGamesTable">
          <thead class="table-light position-sticky top-0">
            <tr>
              <th>ID</th><th>When</th><th>Seed</th><th>Players (order / loser last)</th><th>Wars</th><th>Kills</th><th>Eats</th><th>Trump</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="py-3 small text-center text-muted">
    Skitgubbe Strategy Competition ‚Ä¢ <span id="footerGames"></span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const state = { data: [], segmented: {}, recent: [], sortKey: null, sortDir: 1 };

  function fmtPct(v){return (v*100).toFixed(1)+'%'}
  function clsLoss(v){return v < 0.25 ? 'good' : (v > 0.55 ? 'bad' : 'mid');}

  function decorateMedal(rank){
    if(rank===1) return '<span class="medal gold" title="1st">ü•á</span>';
    if(rank===2) return '<span class="medal silver" title="2nd">ü•à</span>';
    if(rank===3) return '<span class="medal bronze" title="3rd">ü•â</span>';
    return '';
  }

  function sortData(key){
    if(state.sortKey===key){
      state.sortDir*=-1;
    } else {
      state.sortKey=key;
      // rank & strategy default ascending; numeric stats default descending
      state.sortDir = (key==='strategy' || key==='rank') ? 1 : -1;
    }
    state.data.sort((a,b)=>{
      const av=a[key], bv=b[key];
      if(typeof av==='string') return av.localeCompare(bv)*state.sortDir;
      return (av-bv)*state.sortDir;
    });
    renderTable();
  }

  async function fetchStats(){
    const res = await fetch('/stats');
    if(!res.ok) return;
    const payload = await res.json();
    state.data = payload.leaderboard || [];
    state.segmented = payload.segmented || {};
    state.recent = payload.recent_games || [];
    const sourceEl = document.getElementById('dataSource');
    if(payload.source==='db') {sourceEl.textContent='DB'; sourceEl.className='badge bg-success';}
    else if(payload.source==='file') {sourceEl.textContent='FILE'; sourceEl.className='badge bg-warning text-dark';}
    else if(payload.source==='db_unavailable') {sourceEl.textContent='DB DOWN'; sourceEl.className='badge bg-danger';}
    // Preserve baseline rank (payload already sorted by canonical rules on server)
    state.data.forEach((row,i)=> row.rank = i+1);
    if(!state.sortKey){
      // Default: keep canonical rank order ascending without triggering toggle logic
      state.sortKey='rank';
      state.sortDir=1; // ascending
      // Data already in ascending rank order (payload order). Just render.
      renderTable();
    } else {renderTable();}
    renderSegmentedTables();
    renderAggregate();
    renderRecent();
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
  }

  function renderTable(){
    const tbody = document.querySelector('#leaderboardTable tbody');
    tbody.innerHTML='';
    state.data.forEach((row)=>{
      const tr=document.createElement('tr');
      tr.classList.add('row-rank');
      if(row.rank===1) tr.classList.add('rank-1');
      else if(row.rank===2) tr.classList.add('rank-2');
      else if(row.rank===3) tr.classList.add('rank-3');
      tr.innerHTML=`
        <td class="text-center align-middle">${decorateMedal(row.rank) || row.rank}</td>
        <th scope="row" class="fw-semibold strategy-name">${row.strategy || row.name}</th>
        <td>${row.games}</td>
        <td>${row.losses}</td>
        <td><span class="pill pill-${clsLoss(row.loss_rate)}">${fmtPct(row.loss_rate)}</span></td>
        <td>${(row.avg_finish_position || 0).toFixed(2)}</td>
        <td>${(row.avg_wars || 0).toFixed(2)}</td>
        <td>${(row.avg_kills || 0).toFixed(2)}</td>
        <td>${(row.avg_eats || 0).toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('gamesSummary').textContent = state.data.length ? `${totalGames()} total games (aggregate)` : '';
    document.getElementById('footerGames').textContent = state.data.length ? `${totalGames()} games aggregated` : 'no games yet';
    renderCallouts();
  }

  function renderSegmentedTables(){
    ['p3', 'p4', 'p5'].forEach(playerCount => {
      const data = state.segmented[playerCount] || [];
      const tbody = document.querySelector(`#${playerCount}Table tbody`);
      tbody.innerHTML='';
      
      if(data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">No games played with this player count yet</td></tr>';
        return;
      }
      
      data.forEach((row, index)=>{
        const rank = index + 1;
        const tr = document.createElement('tr');
        tr.classList.add('row-rank');
        if(rank===1) tr.classList.add('rank-1');
        else if(rank===2) tr.classList.add('rank-2');
        else if(rank===3) tr.classList.add('rank-3');
        tr.innerHTML=`
          <td class="text-center align-middle">${decorateMedal(rank) || rank}</td>
          <th scope="row" class="fw-semibold strategy-name">${row.strategy || row.name}</th>
          <td>${row.games}</td>
          <td>${row.losses}</td>
          <td><span class="pill pill-${clsLoss(row.loss_rate)}">${fmtPct(row.loss_rate)}</span></td>
          <td>${(row.avg_finish_position || 0).toFixed(2)}</td>
          <td>${(row.avg_wars || 0).toFixed(2)}</td>
          <td>${(row.avg_kills || 0).toFixed(2)}</td>
          <td>${(row.avg_eats || 0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    });
  }

  function totalGames(){
    return state.data.reduce((a,r)=>a+r.games,0);
  }

  function renderAggregate(){
    const target=document.getElementById('aggregate');
    if(!state.data.length){target.innerHTML='<p class="text-muted">No data yet.</p>';return;}
    const avgGames = (totalGames()/state.data.length).toFixed(1);
    const avgLossRate = (state.data.reduce((a,r)=>a+r.loss_rate,0)/state.data.length*100).toFixed(1)+"%";
    const cards=[
      {label:'Strategies', value: state.data.length},
      {label:'Avg Games/Strategy', value: avgGames},
      {label:'Avg Loss Rate', value: avgLossRate},
    ];
    target.innerHTML = cards.map(c=>`<div class="col-auto"><div class="metric-card"><div class="metric-value">${c.value}</div><div class="metric-label">${c.label}</div></div></div>`).join('');
  }

  function renderCallouts(){
    const el=document.getElementById('callouts');
    if(!state.data.length){el.innerHTML='';return;}
    const best = [...state.data].sort((a,b)=>a.loss_rate-b.loss_rate)[0];
    const mostGames = [...state.data].sort((a,b)=>b.games-a.games)[0];
    el.innerHTML=`
      <div class="col-lg-4 col-md-6">
        <div class="highlight-card h-100">üèÜ <strong>${best.strategy}</strong> best loss rate <span class="text-success">${fmtPct(best.loss_rate)}</span></div>
      </div>
      <div class="col-lg-4 col-md-6">
        <div class="highlight-card h-100">üìä <strong>${mostGames.strategy}</strong> most games: <span class="text-primary">${mostGames.games}</span></div>
      </div>`;
  }

  function renderRecent(){
    const card = document.getElementById('recentGamesCard');
    if(!state.recent.length){card.style.display='none';return;}
    card.style.display='block';
    const tbody = document.querySelector('#recentGamesTable tbody');
    tbody.innerHTML='';
    state.recent.forEach(g=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${g.id}</td><td>${fmtTime(g.created_at)}</td><td>${g.seed ?? ''}</td><td>${g.players.join(' ‚Üí ')}</td><td>${g.wars}</td><td>${g.kills}</td><td>${g.eats}</td><td>${g.trump||''}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('recentGamesCount').textContent = state.recent.length + ' shown';
  }

  function fmtTime(ts){
    try { return new Date(ts).toLocaleTimeString(); } catch(e){ return ts; }
  }

  document.getElementById('refreshBtn').addEventListener('click', fetchStats);
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=> sortData(th.dataset.key));
  });
  fetchStats();
  setInterval(fetchStats, 10000);
  </script>
</body>
</html>
